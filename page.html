<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¯¸ì…˜ í˜ì´ì§€ - ë´‰í™© ë©”ëª¨ë¦¬ì¦ˆ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container mission-page">
        <!-- í—¤ë” -->
        <div class="page-header">
            <button class="back-btn" onclick="goHome()">â† í™ˆìœ¼ë¡œ</button>
            <h1 id="pageLocation">ì¥ì†Œ</h1>
        </div>

        <!-- ë©”ì¸ ë¯¸ì…˜ -->
        <div id="mainMissionSection" style="display: none;">
            <div class="mission-box main-mission">
                <div class="mission-badge">ë©”ì¸ ë¯¸ì…˜</div>
                <h2 id="mainTitle"></h2>

                <!-- ìŠ¤í† ë¦¬ (ìˆëŠ” ê²½ìš°) -->
                <div id="mainStory" class="story-box" style="display: none;">
                    <p id="mainStoryText"></p>
                    <button class="skip-btn" onclick="skipTyping()">ìŠ¤í‚µ</button>
                </div>

                <p id="mainDescription" class="mission-description"></p>

                <!-- í€´ì¦ˆ í˜•ì‹ -->
                <div id="mainQuiz" style="display: none;">
                    <input type="text" id="mainAnswer" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”">
                    <button onclick="submitMainAnswer()">ì œì¶œ</button>
                    <div id="mainResult" class="result-message"></div>
                </div>

                <!-- QR í˜•ì‹ -->
                <div id="mainQR" style="display: none;">
                    <p class="qr-guide">ë¯¸ì…˜ì„ ì™„ë£Œí•œ í›„, 'ë¯¸ì…˜ì™„ë£Œ QR'ì„ ìŠ¤ìº”í•˜ì„¸ìš”!</p>
                    <div id="mainQRResult" class="result-message"></div>
                </div>
            </div>
        </div>

        <!-- ë³´ë„ˆìŠ¤ ë¯¸ì…˜ë“¤ -->
        <div id="bonusMissionsSection"></div>

        <!-- ë‹‰ë„¤ì„ ë¯¸ì„¤ì • ì•ˆë‚´ -->
        <div id="noNicknameSection" style="display: none;">
            <div class="info-box">
                <h2>âš ï¸ ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”</h2>
                <p>ë¯¸ì…˜ì„ ì§„í–‰í•˜ë ¤ë©´ ë¨¼ì € ë‹‰ë„¤ì„ì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                <button onclick="goHome()">í™ˆìœ¼ë¡œ ê°€ê¸°</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let currentPageNumber = null;

        window.onload = function() {
            // URLì—ì„œ í˜ì´ì§€ ë²ˆí˜¸ ì¶”ì¶œ
            const urlParams = new URLSearchParams(window.location.search);
            const pageNum = urlParams.get('p');
            const complete = urlParams.get('complete'); // ì™„ë£Œ QRì¸ì§€ í™•ì¸

            if (!pageNum) {
                alert('ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤!');
                goHome();
                return;
            }

            currentPageNumber = parseInt(pageNum);

            // ë‹‰ë„¤ì„ í™•ì¸
            if (!getNickname()) {
                document.getElementById('noNicknameSection').style.display = 'block';
                return;
            }

            // ì™„ë£Œ QR ìŠ¤ìº”ì¸ ê²½ìš°
            if (complete) {
                handleCompleteQR(complete);
                return;
            }

            // í˜ì´ì§€ ë¡œë“œ
            loadPage(currentPageNumber);
        };

        function loadPage(pageNum) {
            const pageData = pagesData[pageNum];

            if (!pageData) {
                alert('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤!');
                goHome();
                return;
            }

            // ì¥ì†Œ í‘œì‹œ
            document.getElementById('pageLocation').textContent = pageData.location;

            // ë©”ì¸ ë¯¸ì…˜ ë¡œë“œ
            if (pageData.mainMission) {
                loadMainMission(pageData.mainMission);
            }

            // ë³´ë„ˆìŠ¤ ë¯¸ì…˜ ë¡œë“œ
            if (pageData.bonusMissions && pageData.bonusMissions.length > 0) {
                loadBonusMissions(pageData.bonusMissions);
            }
        }

        function loadMainMission(mission) {
            const section = document.getElementById('mainMissionSection');
            section.style.display = 'block';

            document.getElementById('mainTitle').textContent = mission.title;
            document.getElementById('mainDescription').textContent = mission.description;

            // ìŠ¤í† ë¦¬ê°€ ìˆìœ¼ë©´ íƒ€ì´í•‘ íš¨ê³¼
            if (mission.story) {
                const storyBox = document.getElementById('mainStory');
                const storyText = document.getElementById('mainStoryText');
                storyBox.style.display = 'block';
                typeText(storyText, mission.story);
            }

            // ì´ë¯¸ ì™„ë£Œëœ ë¯¸ì…˜ì¸ì§€ í™•ì¸
            if (isMissionCompleted(mission.id)) {
                showCompletedMission('main', mission.type);
                return;
            }

            // ë¯¸ì…˜ íƒ€ì…ì— ë”°ë¼ í‘œì‹œ
            if (mission.type === 'quiz') {
                document.getElementById('mainQuiz').style.display = 'block';
            } else if (mission.type === 'qr') {
                document.getElementById('mainQR').style.display = 'block';
            }
        }

        function loadBonusMissions(missions) {
            const section = document.getElementById('bonusMissionsSection');
            section.innerHTML = '';

            missions.forEach((mission, index) => {
                const missionBox = document.createElement('div');
                missionBox.className = 'mission-box bonus-mission';
                missionBox.id = `bonus_${mission.id}`;

                const isCompleted = isMissionCompleted(mission.id);

                let html = `
                    <div class="mission-badge bonus-badge">ë³´ë„ˆìŠ¤ ë¯¸ì…˜ ${index + 1}</div>
                    <h3>${mission.title}</h3>
                    <p class="mission-description">${mission.description}</p>
                `;

                if (isCompleted) {
                    html += `<div class="result-message success">âœ“ ì™„ë£Œë¨</div>`;
                } else {
                    if (mission.type === 'quiz') {
                        html += `
                            <input type="text" id="answer_${mission.id}" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”">
                            <button onclick="submitBonusAnswer('${mission.id}', '${mission.answer}')">ì œì¶œ</button>
                            <div id="result_${mission.id}" class="result-message"></div>
                        `;
                    } else if (mission.type === 'qr') {
                        html += `
                            <p class="qr-guide">ë¯¸ì…˜ì„ ì™„ë£Œí•œ í›„, 'ë¯¸ì…˜ì™„ë£Œ QR'ì„ ìŠ¤ìº”í•˜ì„¸ìš”!</p>
                            <div id="result_${mission.id}" class="result-message"></div>
                        `;
                    }
                }

                missionBox.innerHTML = html;
                section.appendChild(missionBox);
            });
        }

        function submitMainAnswer() {
            const pageData = pagesData[currentPageNumber];
            const mission = pageData.mainMission;
            const userAnswer = document.getElementById('mainAnswer').value.trim();
            const resultDiv = document.getElementById('mainResult');

            if (!userAnswer) {
                alert('ì •ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (compareAnswers(userAnswer, mission.answer)) {
                completeMission(mission.id);
                resultDiv.className = 'result-message success';
                resultDiv.textContent = 'ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ë¯¸ì…˜ ì™„ë£Œ!';

                setTimeout(() => {
                    showCompletedMission('main', mission.type);
                }, 1500);
            } else {
                resultDiv.className = 'result-message error';
                resultDiv.textContent = 'âŒ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”!';
                document.getElementById('mainAnswer').value = '';

                setTimeout(() => {
                    resultDiv.textContent = '';
                }, 2000);
            }
        }

        function submitBonusAnswer(missionId, correctAnswer) {
            const userAnswer = document.getElementById(`answer_${missionId}`).value.trim();
            const resultDiv = document.getElementById(`result_${missionId}`);

            if (!userAnswer) {
                alert('ì •ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (compareAnswers(userAnswer, correctAnswer)) {
                completeMission(missionId);
                resultDiv.className = 'result-message success';
                resultDiv.textContent = 'ğŸ‰ ì •ë‹µì…ë‹ˆë‹¤! ë³´ë„ˆìŠ¤ ë¯¸ì…˜ ì™„ë£Œ!';

                setTimeout(() => {
                    const missionBox = document.getElementById(`bonus_${missionId}`);
                    missionBox.querySelector('input').style.display = 'none';
                    missionBox.querySelector('button').style.display = 'none';
                    resultDiv.textContent = 'âœ“ ì™„ë£Œë¨';
                }, 1500);
            } else {
                resultDiv.className = 'result-message error';
                resultDiv.textContent = 'âŒ í‹€ë ¸ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ë³´ì„¸ìš”!';
                document.getElementById(`answer_${missionId}`).value = '';

                setTimeout(() => {
                    resultDiv.textContent = '';
                }, 2000);
            }
        }

        function showCompletedMission(type, missionType) {
            if (type === 'main') {
                document.getElementById('mainQuiz').style.display = 'none';
                document.getElementById('mainQR').style.display = 'none';
                document.getElementById('mainResult').className = 'result-message success';
                document.getElementById('mainResult').textContent = 'âœ“ ì™„ë£Œë¨';
                document.getElementById('mainQRResult').className = 'result-message success';
                document.getElementById('mainQRResult').textContent = 'âœ“ ì™„ë£Œë¨';

                if (missionType === 'quiz') {
                    document.getElementById('mainResult').style.display = 'block';
                } else {
                    document.getElementById('mainQR').style.display = 'block';
                }
            }
        }

        function handleCompleteQR(missionId) {
            // ì™„ë£Œ QRì„ ìŠ¤ìº”í•œ ê²½ìš°
            if (!getNickname()) {
                alert('ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”!');
                goHome();
                return;
            }

            const completed = completeMission(missionId);

            if (completed) {
                alert('ğŸ‰ ë¯¸ì…˜ ì™„ë£Œ!');
            } else {
                alert('ì´ë¯¸ ì™„ë£Œí•œ ë¯¸ì…˜ì…ë‹ˆë‹¤!');
            }

            // í•´ë‹¹ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ (ì™„ë£Œ í‘œì‹œë¥¼ ìœ„í•´)
            window.location.href = `page.html?p=${currentPageNumber}`;
        }

        // Enter í‚¤ë¡œ ì œì¶œ
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const mainAnswer = document.getElementById('mainAnswer');
                    if (mainAnswer && mainAnswer === document.activeElement) {
                        submitMainAnswer();
                    }
                }
            });
        });
    </script>
</body>
</html>
